# College App - Supabase Setup and API Documentation

## Overview

This application implements a 3-step OTP-based authentication system using Supabase and JWT tokens:

1. **Send OTP**: User enters phone number, receives OTP via SMS
2. **Verify OTP**: User enters OTP, receives JWT token (10-min expiry)
3. **Complete Signup**: User fills profile information using the JWT token

## Prerequisites

1. **Supabase Account**: Create an account at [supabase.com](https://supabase.com)
2. **Twilio Account**: For SMS functionality
3. **Node.js**: Version 18 or higher

## Environment Setup

Create a `.env.local` file in your project root with the following variables:

```bash
# Twilio Configuration
TWILIO_ACCOUNT_SID=your_twilio_account_sid
TWILIO_AUTH_TOKEN=your_twilio_auth_token
TWILIO_SERVICE_ID=your_twilio_verify_service_id

# Supabase Configuration
NEXT_PUBLIC_SUPABASE_URL=your_supabase_url
NEXT_PUBLIC_SUPABASE_ANON_KEY=your_supabase_anon_key

# JWT Configuration
JWT_SECRET=your_jwt_secret_key_at_least_32_characters_long
```

## Supabase Database Setup

The `Student` table should already exist in your Supabase database. If not, create it using this SQL:

```sql
create table public."Student" (
  id bigint generated by default as identity not null,
  email text null,
  "collegeCourse" text not null,
  "firstName" text null,
  "lastName" text null,
  "phoneNumber" bigint not null,
  "dateOfBirth" date null,
  gender text null,
  created_at timestamp with time zone not null default now(),
  otp bigint null,
  token text null,
  "otpExpiresAt" timestamp without time zone null,
  "tokenExpiresat" timestamp without time zone not null,
  "signedUp" boolean null default false,
  constraint Student_pkey primary key (id)
) TABLESPACE pg_default;
```

## API Endpoints

### 1. Send OTP - `/api/send-otp`

**Method**: `POST`

**Request Body**:
```json
{
  "phoneNumber": "+1234567890"
}
```

**Response**:
```json
{
  "success": true,
  "message": "OTP sent successfully",
  "messageSid": "twilio_message_id",
  "userId": 123,
  "otp": "123456" // Only in development mode
}
```

**What it does**:
- Generates a 6-digit OTP
- Stores OTP in database with 5-minute expiration
- Sends SMS via Twilio
- Creates new user record or updates existing one

### 2. Verify OTP - `/api/verify-otp`

**Method**: `POST`

**Request Body**:
```json
{
  "phoneNumber": "+1234567890",
  "otp": "123456"
}
```

**Response**:
```json
{
  "success": true,
  "message": "OTP verified successfully",
  "token": "jwt_token_here",
  "userId": 123,
  "isSignedUp": false
}
```

**What it does**:
- Validates OTP against database
- Checks OTP expiration (5 minutes)
- Generates JWT token with 10-minute expiration
- Clears OTP from database
- Returns token for next step

### 3. Complete Signup - `/api/complete-signup`

**Method**: `POST`

**Request Body**:
```json
{
  "token": "jwt_token_from_verify_step",
  "firstName": "John",
  "lastName": "Doe",
  "email": "john.doe@example.com", // optional
  "dateOfBirth": "1995-01-15", // optional, YYYY-MM-DD format
  "gender": "Male", // optional
  "collegeCourse": "Computer Science"
}
```

**Response**:
```json
{
  "success": true,
  "message": "Signup completed successfully",
  "user": {
    "id": 123,
    "firstName": "John",
    "lastName": "Doe",
    "email": "john.doe@example.com",
    "phoneNumber": 1234567890,
    "collegeCourse": "Computer Science",
    "signedUp": true
  }
}
```

**What it does**:
- Validates JWT token
- Verifies token hasn't expired (10 minutes)
- Updates user profile information
- Sets `signedUp` flag to `true`
- Clears the token from database

## Security Features

1. **OTP Expiration**: OTPs expire after 5 minutes
2. **JWT Token Expiration**: Tokens expire after 10 minutes
3. **Token Validation**: Comprehensive token verification including:
   - JWT signature validation
   - Phone number matching
   - Database token matching
   - Expiration time checking
4. **One-time Use**: Tokens are cleared after successful signup
5. **Environment-based Debugging**: Sensitive information only shown in development

## Error Handling

The APIs return appropriate HTTP status codes:
- `200`: Success
- `400`: Bad Request (validation errors)
- `401`: Unauthorized (invalid/expired tokens)
- `404`: Not Found (user not found)
- `500`: Internal Server Error

## Usage Flow

1. **Frontend calls `/api/send-otp`** with phone number
2. **User receives SMS** with 6-digit OTP
3. **Frontend calls `/api/verify-otp`** with phone number and OTP
4. **Frontend receives JWT token** (valid for 10 minutes)
5. **Frontend calls `/api/complete-signup`** with token and user information
6. **User account is created** and `signedUp` flag is set to `true`

## Database Schema Notes

- `phoneNumber`: Stored as bigint (digits only)
- `otp`: 6-digit number, nullable
- `otpExpiresAt`: Timestamp for OTP expiration
- `token`: JWT token string, nullable
- `tokenExpiresat`: Timestamp for token expiration
- `signedUp`: Boolean flag indicating complete registration

## Development vs Production

- In development mode, the OTP is returned in the response for testing
- In production mode, OTP is only sent via SMS
- Error details are more verbose in development mode

## Installation

The required packages have been installed:
- `@supabase/supabase-js`: Supabase client
- `jsonwebtoken`: JWT token generation and verification
- `@types/jsonwebtoken`: TypeScript types for JWT
